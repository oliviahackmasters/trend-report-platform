<!-- Hackmasters Trend Reports Assistant (Upload + Ask) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<div id="hmTrendChat"></div>

<style>
  :root{
    --hm-black:#000000;
    --hm-white:#FFFFFF;
    --hm-copper:#D18057;
  }

  #hmTrendChat *{ box-sizing: border-box; }

  #hmTrendChat .hm-wrap{
    font-family: "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--hm-black);
    color: var(--hm-white);
    border: 1px solid var(--hm-copper);
    padding: 18px;
    letter-spacing: 0.2px;
  }

  #hmTrendChat .hm-title{
    display:flex;
    align-items:center;
    gap:10px;
    margin: 0 0 14px 0;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-size: 14px;
    color: var(--hm-white);
  }

  #hmTrendChat .hm-title .hm-badge{
    display:inline-block;
    border: 1px solid var(--hm-copper);
    padding: 6px 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.4px;
    font-size: 12px;
    color: var(--hm-copper);
  }

  #hmTrendChat .hm-sub{
    margin: 0 0 14px 0;
    font-size: 12px;
    line-height: 1.5;
    color: rgba(255,255,255,0.85);
  }

  #hmTrendChat .hm-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin: 10px 0;
  }

  #hmTrendChat .hm-btn{
    appearance:none;
    background: transparent;
    color: var(--hm-white);
    border: 1px solid var(--hm-copper);
    padding: 10px 12px;
    cursor:pointer;
    text-transform: uppercase;
    letter-spacing: 1.1px;
    font-weight: 600;
    font-size: 12px;
    line-height: 1;
    border-radius: 0;
    transition: background 120ms linear, color 120ms linear;
  }
  #hmTrendChat .hm-btn:hover{
    background: var(--hm-copper);
    color: var(--hm-black);
  }
  #hmTrendChat .hm-btn:disabled{
    opacity: 0.55;
    cursor:not-allowed;
  }

  #hmTrendChat .hm-status{
    margin-left:auto;
    font-size: 12px;
    letter-spacing: 0.9px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.85);
  }
  #hmTrendChat .hm-status.is-error{ color: var(--hm-copper); }

  #hmTrendChat .hm-divider{
    height: 1px;
    background: rgba(209,128,87,0.45);
    margin: 14px 0;
  }

  /* Upload */
  #hmTrendChat .hm-file{
    flex: 1 1 auto;
    min-width: 220px;
    border: 1px solid var(--hm-copper);
    padding: 10px 12px;
    color: rgba(255,255,255,0.85);
    background: transparent;
    border-radius: 0;
    font-size: 12px;
  }
  #hmTrendChat input[type="file"]::file-selector-button{
    border: 1px solid var(--hm-copper);
    background: transparent;
    color: var(--hm-white);
    padding: 8px 10px;
    border-radius: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
    cursor:pointer;
    margin-right: 10px;
  }
  #hmTrendChat input[type="file"]::file-selector-button:hover{
    background: var(--hm-copper);
    color: var(--hm-black);
  }

  #hmTrendChat .hm-prompts{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  #hmTrendChat .hm-prompt{
    text-align:left;
    padding: 12px;
    border: 1px solid var(--hm-copper);
    background: rgba(255,255,255,0.02);
    color: var(--hm-white);
    border-radius: 0;
    cursor:pointer;
    font-weight: 600;
    font-size: 13px;
    line-height: 1.35;
  }
  #hmTrendChat .hm-prompt:hover{
    background: rgba(209,128,87,0.18);
  }

  /* Chat transcript */
  #hmTrendChat .hm-chat{
    margin-top: 14px;
    border: 1px solid var(--hm-copper);
    background: rgba(255,255,255,0.02);
    padding: 12px;
    max-height: 420px;
    overflow:auto;
  }

  #hmTrendChat .hm-msg{
    border: 1px solid rgba(209,128,87,0.55);
    padding: 10px 12px;
    margin: 0 0 10px 0;
    border-radius: 0;
    word-break: break-word;
    overflow-wrap: anywhere;
    line-height: 1.6;
    font-size: 13px;
  }
  #hmTrendChat .hm-msg.hm-me{
    background: rgba(209,128,87,0.10);
  }
  #hmTrendChat .hm-msg.hm-ai{
    background: rgba(255,255,255,0.01);
  }
  #hmTrendChat .hm-msg-title{
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--hm-copper);
    font-size: 12px;
    margin-bottom: 6px;
  }

  /* Markdown-ish formatting in assistant messages */
  #hmTrendChat .hm-msg-body p{ margin: 0 0 10px 0; }
  #hmTrendChat .hm-msg-body strong{
    color: var(--hm-copper);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  #hmTrendChat .hm-msg-body ul,
  #hmTrendChat .hm-msg-body ol{
    margin: 10px 0 12px 18px;
    padding: 0;
  }
  #hmTrendChat .hm-msg-body li{ margin: 6px 0; }

  /* Input bar */
  #hmTrendChat .hm-inputRow{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top: 12px;
  }
  #hmTrendChat .hm-input{
    width:100%;
    display:block;
    background: transparent;
    color: var(--hm-white);
    border: 1px solid var(--hm-copper);
    padding: 12px;
    border-radius: 0;
    outline:none;
    font-size: 13px;
  }
  #hmTrendChat .hm-input::placeholder{ color: rgba(255,255,255,0.65); }

  /* Library */
  #hmTrendChat .hm-lib{
    border: 1px solid var(--hm-copper);
    background: rgba(255,255,255,0.02);
    padding: 12px;
  }
  #hmTrendChat .hm-lib-title{
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:1.2px;
    color: var(--hm-copper);
    font-size: 12px;
    margin: 0 0 10px 0;
  }
  #hmTrendChat .hm-lib-row{
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content:space-between;
    border-top: 1px solid rgba(209,128,87,0.35);
    padding-top:10px;
    margin-top:10px;
  }
  #hmTrendChat .hm-lib-meta{
    font-size: 12px;
    line-height: 1.5;
    color: rgba(255,255,255,0.85);
    word-break: break-word;
  }
  #hmTrendChat .hm-lib-tags{ color: rgba(255,255,255,0.75); }
  #hmTrendChat .hm-lib-actions{
    flex: 0 0 auto;
    display:flex;
    gap:8px;
  }
</style>

<script>
(() => {
  // CONFIG
  const API_BASE = "https://trend-report-platform.vercel.app";
  const DEMO_TOKEN = "";

  const mount = document.getElementById("hmTrendChat");
  mount.innerHTML = `
    <div class="hm-wrap">
      <div class="hm-title">
        <span class="hm-badge">HACKMASTERS</span>
        <span>TREND BOILER</span>
      </div>
      <p class="hm-sub">
        Upload trend reports (PDF) and ask questions grounded in your documents.
      </p>

      <div class="hm-row">
        <button class="hm-btn" id="hmNewSession">NEW SESSION</button>
        <div class="hm-status" id="hmStatus">READY</div>
      </div>

      <div class="hm-divider"></div>

      <div class="hm-row">
        <input class="hm-file" type="file" id="hmFiles" accept="application/pdf" multiple />
        <button class="hm-btn" id="hmUpload">UPLOAD PDFS</button>
      </div>

      <div class="hm-prompts">
        <button class="hm-prompt" data-prompt="What are the key trends across these reports?">What are the key trends across these reports?</button>
        <button class="hm-prompt" data-prompt="Summarize insights related to AI across the documents.">Summarize insights related to AI across the documents.</button>
        <button class="hm-prompt" data-prompt="What do these reports say about consumer behavior and cultural change?">What do these reports say about consumer behavior and cultural change?</button>
        <button class="hm-prompt" data-prompt="Compare themes across documents and highlight any contradictions.">Compare themes across documents and highlight any contradictions.</button>
      </div>

      <div class="hm-row" style="margin-top: 6px;">
        <input class="hm-input" id="hmTagYear" placeholder="YEAR (e.g. 2024)" style="max-width:160px;" />
        <input class="hm-input" id="hmTagCompany" placeholder="COMPANY / SOURCE" style="max-width:240px;" />
        <input class="hm-input" id="hmTagTopics" placeholder="TOPICS (comma separated)" />
      </div>

      <div class="hm-divider"></div>

      <div id="hmLibrary" style="margin-top:10px;"></div>

      <div class="hm-divider"></div>

      <div class="hm-chat" id="hmChat"></div>

      <div class="hm-inputRow">
        <input class="hm-input" id="hmQ" placeholder="ASK ABOUT TRENDS, INSIGHTS, OR A SPECIFIC REPORT…" />
        <button class="hm-btn" id="hmAsk">SEND</button>
      </div>
    </div>
  `;

  const statusEl = mount.querySelector("#hmStatus");
  const fileEl = mount.querySelector("#hmFiles");
  const uploadBtn = mount.querySelector("#hmUpload");
  const askBtn = mount.querySelector("#hmAsk");
  const qEl = mount.querySelector("#hmQ");
  const chatEl = mount.querySelector("#hmChat");
  const newBtn = mount.querySelector("#hmNewSession");

  const libEl = mount.querySelector("#hmLibrary");
  const tagYearEl = mount.querySelector("#hmTagYear");
  const tagCompanyEl = mount.querySelector("#hmTagCompany");
  const tagTopicsEl = mount.querySelector("#hmTagTopics");

  const LS_KEY = "hm_trendchat_sessionToken";
  let sessionToken = localStorage.getItem(LS_KEY) || "";
  let history = [];

  function setStatus(text, isError=false){
    statusEl.textContent = text || "";
    statusEl.classList.toggle("is-error", !!isError);
  }

  function headersJson(extra={}){
    const h = { "Content-Type":"application/json", ...extra };
    if (DEMO_TOKEN) h["Authorization"] = "Bearer " + DEMO_TOKEN;
    if (sessionToken) h["x-session-token"] = sessionToken;
    return h;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function formatMarkdownToHtml(text){
    const src = String(text || "");
    const safe = escapeHtml(src);

    const blocks = safe.split(/\n\s*\n/).map(b => b.trim()).filter(Boolean);

    return blocks.map(block => {
      let b = block.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
      const lines = b.split("\n").map(l => l.trim()).filter(Boolean);

      const isList = lines.length > 1 && lines.every(l => /^(\-|\•|\*|\d+\.)\s+/.test(l));
      if (isList){
        const isOrdered = lines.every(l => /^\d+\.\s+/.test(l));
        const items = lines.map(l => l.replace(/^(\-|\•|\*|\d+\.)\s+/, "").trim());
        return isOrdered
          ? `<ol>${items.map(i => `<li>${i}</li>`).join("")}</ol>`
          : `<ul>${items.map(i => `<li>${i}</li>`).join("")}</ul>`;
      }

      return `<p>${b.replace(/\n/g, "<br>")}</p>`;
    }).join("");
  }

  function addMsg(who, text){
    const wrap = document.createElement("div");
    wrap.className = "hm-msg " + (who === "me" ? "hm-me" : "hm-ai");

    const title = document.createElement("div");
    title.className = "hm-msg-title";
    title.textContent = who === "me" ? "YOU" : "TREND BOILER";

    const body = document.createElement("div");
    body.className = "hm-msg-body";
    body.innerHTML = (who === "ai")
      ? formatMarkdownToHtml(text || "")
      : escapeHtml(text || "");

    wrap.appendChild(title);
    wrap.appendChild(body);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addSys(text, isError=false){
    // status bar + also log into chat (clearer)
    setStatus(text, isError);
    addMsg("ai", text);
  }

  async function ensureSession(){
    if (sessionToken) return;
    setStatus("CREATING SESSION…");
    const resp = await fetch(API_BASE + "/api/session", {
      method:"POST",
      headers: headersJson(),
      body: JSON.stringify({ title: "Trend Reports Session" })
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || "SESSION FAILED");
    sessionToken = data.sessionToken;
    localStorage.setItem(LS_KEY, sessionToken);
    setStatus("SESSION READY");
  }

  function fmtDate(iso){
    try { return new Date(iso).toLocaleString(); } catch { return iso || ""; }
  }

  function renderLibrary(items){
    const rows = (items || []).map(x => {
      const topics = (x.tags?.topics || []).join(", ");
      const year = x.tags?.year || "";
      const company = x.tags?.company || "";

      return `
        <div class="hm-lib-row">
          <div class="hm-lib-meta">
            <div><strong>${escapeHtml(x.filename || x.pathname || "REPORT")}</strong></div>
            <div class="hm-lib-tags">
              ADDED: ${escapeHtml(fmtDate(x.addedAt))}<br>
              YEAR: ${escapeHtml(year)} &nbsp; | &nbsp;
              COMPANY: ${escapeHtml(company)}<br>
              TOPICS: ${escapeHtml(topics || "—")}
            </div>
          </div>
          <div class="hm-lib-actions">
            <button class="hm-btn" data-del="${escapeHtml(x.hash)}">DELETE</button>
          </div>
        </div>
      `;
    }).join("");

    libEl.innerHTML = `
      <div class="hm-lib">
        <div class="hm-lib-title">LIBRARY (${(items||[]).length})</div>
        ${rows || `<div class="hm-lib-meta">NO REPORTS SAVED YET.</div>`}
      </div>
    `;

    libEl.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const hash = btn.getAttribute("data-del");
        if (!hash) return;

        btn.disabled = true;
        setStatus("DELETING…");

        try{
          const resp = await fetch(API_BASE + "/api/delete", {
            method: "POST",
            headers: headersJson(),
            body: JSON.stringify({ hash })
          });
          const data = await resp.json().catch(()=>({}));
          if (!resp.ok) throw new Error((data.error || "DELETE FAILED") + (data.details ? " — " + data.details : ""));
          addSys("DELETED ✅");
          await refreshLibrary();
        } catch(e){
          addSys("DELETE ERROR: " + (e.message || e), true);
        } finally {
          btn.disabled = false;
        }
      });
    });
  }

  async function refreshLibrary(){
    try{
      const resp = await fetch(API_BASE + "/api/library", {
        method: "GET",
        headers: headersJson()
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok) throw new Error(data.error || "LIBRARY FAILED");
      renderLibrary(data.items || []);
    } catch(e){
      setStatus("LIBRARY ERROR", true);
    }
  }

  async function uploadFiles(){
    const files = Array.from(fileEl.files || []);
    if (!files.length) return addSys("CHOOSE PDFS FIRST", true);

    await ensureSession();

    uploadBtn.disabled = true;
    askBtn.disabled = true;
    setStatus("UPLOADING…");

    const tags = {
      year: (tagYearEl.value || "").trim(),
      company: (tagCompanyEl.value || "").trim(),
      topics: (tagTopicsEl.value || "").split(",").map(s => s.trim()).filter(Boolean)
    };

    try{
      const { upload } = await import("https://esm.sh/@vercel/blob@2.0.0/client");

      for (const file of files){
        if (!String(file.name).toLowerCase().endsWith(".pdf")) {
          throw new Error("ONLY PDFS ALLOWED: " + file.name);
        }

        const blob = await upload(file.name, file, {
          access: "public",
          handleUploadUrl: API_BASE + "/api/blob-upload-url",
          headers: DEMO_TOKEN ? { Authorization: "Bearer " + DEMO_TOKEN } : undefined
        });

        const ingestResp = await fetch(API_BASE + "/api/ingest", {
          method: "POST",
          headers: headersJson(),
          body: JSON.stringify({
            blobUrl: blob.url,
            pathname: blob.pathname,
            filename: file.name,
            size: file.size,
            tags
          })
        });

        const ingestData = await ingestResp.json().catch(()=>({}));
        if (!ingestResp.ok){
          throw new Error((ingestData.error || "INGEST FAILED") + (ingestData.details ? " — " + ingestData.details : ""));
        }
        if (ingestData.duplicate){
          addMsg("ai", `DUPLICATE SKIPPED: ${file.name}`);
        } else {
          addMsg("ai", `ADDED: ${file.name} ✅`);
        }
      }

      setStatus("UPLOAD COMPLETE");
      fileEl.value = "";
      await refreshLibrary();
    } catch(e){
      addSys("UPLOAD ERROR: " + (e.message || e), true);
    } finally {
      uploadBtn.disabled = false;
      askBtn.disabled = false;
    }
  }

  async function ask(question){
    const q = (question || "").trim();
    if (!q) return;

    await ensureSession();

    addMsg("me", q);
    setStatus("THINKING…");
    addMsg("ai", "THINKING…");

    askBtn.disabled = true;
    uploadBtn.disabled = true;

    try{
      const resp = await fetch(API_BASE + "/api/ask", {
        method:"POST",
        headers: headersJson(),
        body: JSON.stringify({ question: q, history })
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok) throw new Error((data.error || "REQUEST FAILED") + (data.details ? " — " + data.details : ""));

      addMsg("ai", data.answer || "");
      history = [...history,
        { role:"user", content: q },
        { role:"assistant", content: data.answer || "" }
      ].slice(-16);

      setStatus("DONE");
      addMsg("ai", "DONE.");
    } catch(e){
      addSys("ERROR: " + (e.message || e), true);
    } finally {
      askBtn.disabled = false;
      uploadBtn.disabled = false;
    }
  }

  // Events
  uploadBtn.addEventListener("click", uploadFiles);

  askBtn.addEventListener("click", () => {
    const q = (qEl.value || "").trim();
    if (!q) return;
    qEl.value = "";
    ask(q);
  });

  qEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      askBtn.click();
    }
  });

  mount.querySelectorAll(".hm-prompt").forEach(btn => {
    btn.addEventListener("click", () => ask(btn.getAttribute("data-prompt")));
  });

  newBtn.addEventListener("click", () => {
    sessionToken = "";
    localStorage.removeItem(LS_KEY);
    history = [];
    chatEl.innerHTML = "";
    addSys("NEW SESSION READY (UPLOAD PDFS)");
  });

  setStatus(sessionToken ? "SESSION READY" : "READY (UPLOAD PDFS)");
  refreshLibrary();
})();
</script>
