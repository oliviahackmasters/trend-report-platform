<!-- Hackmasters Trend Reports Assistant (Upload + Ask) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<div id="hmTrendChat"></div>

<style>
  :root{
    --hm-black:#000000;
    --hm-white:#FFFFFF;
    --hm-copper:#D18057;
  }

  #hmTrendChat *{ box-sizing: border-box; }

  #hmTrendChat .hm-wrap{
    font-family: "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--hm-black);
    color: var(--hm-white);
    border: 1px solid var(--hm-copper);
    padding: 18px;
    letter-spacing: 0.2px;
  }

  #hmTrendChat .hm-title{
    display:flex;
    align-items:center;
    gap:10px;
    margin: 0 0 14px 0;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-size: 14px;
    color: var(--hm-white);
  }

  #hmTrendChat .hm-title .hm-badge{
    display:inline-block;
    border: 1px solid var(--hm-copper);
    padding: 6px 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.4px;
    font-size: 12px;
    color: var(--hm-copper);
  }

  #hmTrendChat .hm-sub{
    margin: 0 0 14px 0;
    font-size: 12px;
    line-height: 1.5;
    color: rgba(255,255,255,0.85);
  }

  #hmTrendChat .hm-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin: 10px 0;
  }

  #hmTrendChat .hm-textarea{
      resize: none;
      overflow: hidden;
      min-height: 44px;
      max-height: 160px;   /* cap so it doesn't take over the page */
      line-height: 1.4;
    }


  #hmTrendChat .hm-btn{
    appearance:none;
    background: transparent;
    color: var(--hm-white);
    border: 1px solid var(--hm-copper);
    padding: 10px 12px;
    cursor:pointer;
    text-transform: uppercase;
    letter-spacing: 1.1px;
    font-weight: 600;
    font-size: 12px;
    line-height: 1;
    border-radius: 0;
    transition: background 120ms linear, color 120ms linear;
  }
  #hmTrendChat .hm-btn:hover{
    background: var(--hm-copper);
    color: var(--hm-black);
  }
  #hmTrendChat .hm-btn:disabled{
    opacity: 0.55;
    cursor:not-allowed;
  }

  #hmTrendChat .hm-status{
    margin-left:auto;
    font-size: 12px;
    letter-spacing: 0.9px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.85);
  }
  #hmTrendChat .hm-status.is-error{ color: var(--hm-copper); }

  #hmTrendChat .hm-divider{
    height: 1px;
    background: rgba(209,128,87,0.45);
    margin: 14px 0;
  }

  /* Upload */
  #hmTrendChat .hm-file{
    flex: 1 1 auto;
    min-width: 220px;
    border: 1px solid var(--hm-copper);
    padding: 10px 12px;
    color: rgba(255,255,255,0.85);
    background: transparent;
    border-radius: 0;
    font-size: 12px;
  }
  #hmTrendChat input[type="file"]::file-selector-button{
    border: 1px solid var(--hm-copper);
    background: transparent;
    color: var(--hm-white);
    padding: 8px 10px;
    border-radius: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
    cursor:pointer;
    margin-right: 10px;
  }
  #hmTrendChat input[type="file"]::file-selector-button:hover{
    background: var(--hm-copper);
    color: var(--hm-black);
  }

  #hmTrendChat .hm-prompts{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  #hmTrendChat .hm-prompt{
    text-align:left;
    padding: 12px;
    border: 1px solid var(--hm-copper);
    background: rgba(255,255,255,0.02);
    color: var(--hm-white);
    border-radius: 0;
    cursor:pointer;
    font-weight: 600;
    font-size: 13px;
    line-height: 1.35;
  }
  #hmTrendChat .hm-prompt:hover{
    background: rgba(209,128,87,0.18);
  }

  /* Chat transcript */
  #hmTrendChat .hm-chat{
    margin-top: 14px;
    border: 1px solid var(--hm-copper);
    background: rgba(255,255,255,0.02);
    padding: 12px;
    max-height: 650px;
    overflow:auto;
  }

  #hmTrendChat .hm-msg{
    border: 1px solid rgba(209,128,87,0.55);
    padding: 10px 12px;
    margin: 0 0 10px 0;
    border-radius: 0;
    word-break: break-word;
    overflow-wrap: anywhere;
    line-height: 1.6;
    font-size: 13px;
  }
  #hmTrendChat .hm-msg.hm-me{
    background: rgba(209,128,87,0.10);
  }
  #hmTrendChat .hm-msg.hm-ai{
    background: rgba(255,255,255,0.01);
  }
  #hmTrendChat .hm-msg-title{
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--hm-copper);
    font-size: 12px;
    margin-bottom: 6px;
  }

  /* Markdown-ish formatting in assistant messages */
  #hmTrendChat .hm-msg-body p{ margin: 0 0 10px 0; }
  #hmTrendChat .hm-msg-body strong{
    color: var(--hm-copper);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  #hmTrendChat .hm-msg-body ul,
  #hmTrendChat .hm-msg-body ol{
    margin: 10px 0 12px 18px;
    padding: 0;
  }
  #hmTrendChat .hm-msg-body li{ margin: 6px 0; }

  /* Input bar */
  #hmTrendChat .hm-inputRow{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top: 12px;
  }
  #hmTrendChat .hm-input{
    width:100%;
    display:block;
    background: transparent;
    color: var(--hm-white);
    border: 1px solid var(--hm-copper);
    padding: 12px;
    border-radius: 0;
    outline:none;
    font-size: 13px;
  }
  #hmTrendChat .hm-input::placeholder{ color: rgba(255,255,255,0.65); }

  /* Library */
  #hmTrendChat .hm-lib{
    border: 1px solid var(--hm-copper);
    background: rgba(255,255,255,0.02);
    padding: 12px;
  }
  #hmTrendChat .hm-lib-title{
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:1.2px;
    color: var(--hm-copper);
    font-size: 12px;
    margin: 0 0 10px 0;
  }
  #hmTrendChat .hm-lib-row{
    display:flex;
    gap:10px;
    align-items:flex-start;
    justify-content:space-between;
    border-top: 1px solid rgba(209,128,87,0.35);
    padding-top:10px;
    margin-top:10px;
  }
  #hmTrendChat .hm-lib-meta{
    font-size: 12px;
    line-height: 1.5;
    color: rgba(255,255,255,0.85);
    word-break: break-word;
  }
  #hmTrendChat .hm-lib-tags{ color: rgba(255,255,255,0.75); }
  #hmTrendChat .hm-lib-actions{
    flex: 0 0 auto;
    display:flex;
    gap:8px;
  }


  /* Library toggle */
#hmTrendChat .hm-libHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-top: 10px;
}

#hmTrendChat .hm-libToggle{
  padding: 8px 10px;
  font-size: 11px;
}

#hmTrendChat .hm-hidden{ display:none !important; }

  /* Future Map */
  #hmTrendChat .hm-mapWrap{
    border: 1px solid var(--hm-copper);
    background: rgba(255,255,255,0.02);
    padding: 12px;
    margin-top: 10px;
  }
  #hmTrendChat .hm-mapTop{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin-bottom: 10px;
  }
  #hmTrendChat .hm-mapTitle{
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:1.2px;
    color: var(--hm-copper);
    font-size: 12px;
    margin: 0;
  }
  #hmTrendChat .hm-mapControls{
    display:flex;
    gap:10px;
    flex: 1 1 auto;
    align-items:center;
    justify-content:flex-end;
    flex-wrap:wrap;
  }
  #hmTrendChat .hm-mapInput{
    flex: 1 1 320px;
    min-width: 220px;
    background: transparent;
    color: var(--hm-white);
    border: 1px solid var(--hm-copper);
    padding: 10px 12px;
    border-radius: 0;
    outline:none;
    font-size: 13px;
  }
  #hmTrendChat .hm-mapSvg{
    width: 100%;
    display:block;
    border: 1px solid rgba(209,128,87,0.45);
    background: #000;
  }


</style>

<script>
(() => {
  // CONFIG
  const API_BASE = "https://trend-report-platform.vercel.app";
  const DEMO_TOKEN = "";

  const mount = document.getElementById("hmTrendChat");
  mount.innerHTML = `
    <div class="hm-wrap">
      <div class="hm-title">
        <span class="hm-badge">HACKMASTERS</span>
        <span>TREND BOILER</span>
      </div>
      <p class="hm-sub">
        Upload trend reports (PDF) and ask questions grounded in your documents.
      </p>

      <div class="hm-row">
        <button class="hm-btn" id="hmNewSession">NEW SESSION</button>
        <div class="hm-status" id="hmStatus">READY</div>
      </div>

      <div class="hm-divider"></div>

      <div class="hm-row">
        <input class="hm-file" type="file" id="hmFiles" accept="application/pdf" multiple />
        <button class="hm-btn" id="hmUpload">UPLOAD PDFS</button>
      </div>

      <div class="hm-divider"></div>

      <div class="hm-libHeader">
        <div class="hm-lib-title" style="margin:0;">LIBRARY</div>
        <button class="hm-btn hm-libToggle" id="hmLibToggle">HIDE</button>
      </div>
      <div id="hmLibrary" style="margin-top:10px;"></div>
  
            <div class="hm-divider"></div>


      <div class="hm-mapTop">
    <div class="hm-mapTitle">FUTURE MAP</div>
    <div class="hm-mapControls">
      <input class="hm-mapInput" id="hmMapTheme" placeholder="Generate a future map based on… (e.g. Retail, Health, AI in education)" />
      <button class="hm-btn" id="hmMapGen">GENERATE</button>
      <button class="hm-btn" id="hmMapPng" disabled>DOWNLOAD PNG</button>
    </div>
  </div>

      <div class="hm-mapWrap hm-hidden" id="hmMapWrap">



 <svg id="hmFutureMap" class="hm-mapSvg" viewBox="0 0 1200 750" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Future Map">
    <rect x="0" y="0" width="1200" height="750" fill="#000"/>

    <!-- Title -->
    <text x="30" y="70" fill="#FFFFFF" font-size="54" font-family="Montserrat, system-ui, sans-serif" font-weight="700">FUTURE MAP</text>
    <text id="hmMapThemeLabel" x="30" y="100" fill="#D18057" font-size="20" font-family="Montserrat, system-ui, sans-serif" font-weight="600"></text>

    <!-- Heptagons injected by JS -->
    <g id="hmHeptagons"></g>

    <!-- LENS HEADERS -->
    <g font-family="Montserrat, system-ui, sans-serif">
      <!-- PROFIT / MODELS (upper-left) -->
      <text x="20" y="230" fill="#FFFFFF" font-size="18" font-weight="700">PROFIT / MODELS</text>
      <text id="lens_profit_models" x="20" y="250" fill="#D18057" font-size="14" font-weight="400"></text>

      <!-- PEOPLE (top-centre) -->
      <text x="600" y="130" fill="#FFFFFF" font-size="18" font-weight="700" text-anchor="middle">PEOPLE / ATTITUDES + BEHAVIOURS</text>
      <text id="lens_people_attitudes_behaviours" x="600" y="150" fill="#D18057" font-size="14" font-weight="400" text-anchor="middle"></text>

      <!-- POLITICS / REGULATION (upper-right) -->
      <text x="790" y="230" fill="#FFFFFF" font-size="18" font-weight="700">POLITICS / REGULATION</text>
      <text id="lens_politics_regulation" x="790" y="250" fill="#D18057" font-size="14" font-weight="400"></text>

      <!-- PROSPERITY / ECONOMIC FACTORS (right-mid) -->
      <text x="790" y="430" fill="#FFFFFF" font-size="18" font-weight="700">PROSPERITY / ECONOMIC FACTORS</text>
      <text id="lens_prosperity_economic_factors" x="790" y="450" fill="#D18057" font-size="14" font-weight="400"></text>

      <!-- PLANET / SUSTAINABILITY (bottom-right) -->
      <text x="790" y="610" fill="#FFFFFF" font-size="18" font-weight="700">PLANET / SUSTAINABILITY</text>
      <text id="lens_planet_sustainability" x="790" y="630" fill="#D18057" font-size="14" font-weight="400"></text>

      <!-- PLACES / CHANNELS (bottom-left) -->
      <text x="20" y="610" fill="#FFFFFF" font-size="18" font-weight="700">PLACES / CHANNELS</text>
      <text id="lens_places_channels" x="20" y="630" fill="#D18057" font-size="14" font-weight="400"></text>

      <!-- POTENTIAL / CAPABILITY (left-mid) -->
      <text x="20" y="430" fill="#FFFFFF" font-size="18" font-weight="700">POTENTIAL / CAPABILITY</text>
      <text id="lens_potential_capability" x="20" y="450" fill="#D18057" font-size="14" font-weight="400"></text>
    </g>

    <!-- Footer -->
    <text x="30" y="740" fill="#D18057" font-size="14" font-family="Montserrat, system-ui, sans-serif" font-weight="600">HACKMASTERS © 2026</text>
  </svg>


  </div>



      <div class="hm-divider"></div>

      <div class="hm-chat" id="hmChat"></div>

      <div class="hm-inputRow">
        <textarea class="hm-input hm-textarea" id="hmQ" rows="1" placeholder="ASK ABOUT TRENDS, INSIGHTS, OR A SPECIFIC REPORT…"></textarea>
        <button class="hm-btn" id="hmAsk">SEND</button>
      </div>
    </div>
  `;

  const statusEl = mount.querySelector("#hmStatus");
  const fileEl = mount.querySelector("#hmFiles");
  const uploadBtn = mount.querySelector("#hmUpload");
  const askBtn = mount.querySelector("#hmAsk");
  const qEl = mount.querySelector("#hmQ");
  const chatEl = mount.querySelector("#hmChat");
  const newBtn = mount.querySelector("#hmNewSession");

  const libEl = mount.querySelector("#hmLibrary");
  const tagYearEl = mount.querySelector("#hmTagYear");
  const tagCompanyEl = mount.querySelector("#hmTagCompany");
  const tagTopicsEl = mount.querySelector("#hmTagTopics");

  const mapThemeEl = mount.querySelector("#hmMapTheme");
  const mapGenBtn = mount.querySelector("#hmMapGen");
  const mapPngBtn = mount.querySelector("#hmMapPng");
  const mapSvg = mount.querySelector("#hmFutureMap");
  const mapThemeLabel = mount.querySelector("#hmMapThemeLabel");
  const mapWrapEl = mount.querySelector("#hmMapWrap");



  const LS_KEY = "hm_trendchat_sessionToken";
  let sessionToken = localStorage.getItem(LS_KEY) || "";
  let history = [];

  function setStatus(text, isError=false){
    statusEl.textContent = text || "";
    statusEl.classList.toggle("is-error", !!isError);
  }

  const libToggleBtn = mount.querySelector("#hmLibToggle");

let libVisible = false;
// Start hidden on page load
libEl.classList.add("hm-hidden");
libToggleBtn.textContent = "SHOW";

  libToggleBtn.addEventListener("click", () => {
    libVisible = !libVisible;
    libEl.classList.toggle("hm-hidden", !libVisible);
    libToggleBtn.textContent = libVisible ? "HIDE" : "SHOW";
  });

  function autoSizeTextarea(el){
    el.style.height = "auto";
    el.style.height = Math.min(el.scrollHeight, 160) + "px";
  }

  qEl.addEventListener("input", () => autoSizeTextarea(qEl));
  autoSizeTextarea(qEl);

  mapGenBtn.addEventListener("click", generateFutureMap);
  mapPngBtn.addEventListener("click", downloadFutureMapPng);

  mapThemeEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      mapGenBtn.click();
    }
  });



  function headersJson(extra={}){
    const h = { "Content-Type":"application/json", ...extra };
    if (DEMO_TOKEN) h["Authorization"] = "Bearer " + DEMO_TOKEN;
    if (sessionToken) h["x-session-token"] = sessionToken;
    return h;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function formatMarkdownToHtml(text){
    const src = String(text || "");
    const safe = escapeHtml(src);

    const blocks = safe.split(/\n\s*\n/).map(b => b.trim()).filter(Boolean);

    return blocks.map(block => {
      let b = block.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
      const lines = b.split("\n").map(l => l.trim()).filter(Boolean);

      const isList = lines.length > 1 && lines.every(l => /^(\-|\•|\*|\d+\.)\s+/.test(l));
      if (isList){
        const isOrdered = lines.every(l => /^\d+\.\s+/.test(l));
        const items = lines.map(l => l.replace(/^(\-|\•|\*|\d+\.)\s+/, "").trim());
        return isOrdered
          ? `<ol>${items.map(i => `<li>${i}</li>`).join("")}</ol>`
          : `<ul>${items.map(i => `<li>${i}</li>`).join("")}</ul>`;
      }

      return `<p>${b.replace(/\n/g, "<br>")}</p>`;
    }).join("");
  }

  function addMsg(who, text){
    const wrap = document.createElement("div");
    wrap.className = "hm-msg " + (who === "me" ? "hm-me" : "hm-ai");

    const title = document.createElement("div");
    title.className = "hm-msg-title";
    title.textContent = who === "me" ? "YOU" : "TREND BOILER";

    const body = document.createElement("div");
    body.className = "hm-msg-body";
    body.innerHTML = (who === "ai")
      ? formatMarkdownToHtml(text || "")
      : escapeHtml(text || "");

    wrap.appendChild(title);
    wrap.appendChild(body);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addSys(text, isError=false){
    // status bar + also log into chat (clearer)
    setStatus(text, isError);
    addMsg("ai", text);
  }

  async function ensureSession(){
    if (sessionToken) return;
    setStatus("CREATING SESSION…");
    const resp = await fetch(API_BASE + "/api/session", {
      method:"POST",
      headers: headersJson(),
      body: JSON.stringify({ title: "Trend Reports Session" })
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || "SESSION FAILED");
    sessionToken = data.sessionToken;
    localStorage.setItem(LS_KEY, sessionToken);
    setStatus("SESSION READY");
  }

  function fmtDate(iso){
    try { return new Date(iso).toLocaleString(); } catch { return iso || ""; }
  }

  function renderLibrary(items){
    const rows = (items || []).map(x => {
      const topics = (x.tags?.topics || []).join(", ");
      const year = x.tags?.year || "";
      const company = x.tags?.company || "";

      return `
        <div class="hm-lib-row">
          <div class="hm-lib-meta">
            <div><strong>${escapeHtml(x.filename || x.pathname || "REPORT")}</strong></div>
            <div class="hm-lib-tags">
              ADDED: ${escapeHtml(fmtDate(x.addedAt))}<br>
              YEAR: ${escapeHtml(year)} &nbsp; | &nbsp;
              COMPANY: ${escapeHtml(company)}<br>
              TOPICS: ${escapeHtml(topics || "—")}
            </div>
          </div>
          <div class="hm-lib-actions">
            <button class="hm-btn" data-del="${escapeHtml(x.hash)}">DELETE</button>
          </div>
        </div>
      `;
    }).join("");

    libEl.innerHTML = `
      <div class="hm-lib">
        <div class="hm-lib-title">LIBRARY (${(items||[]).length})</div>
        ${rows || `<div class="hm-lib-meta">NO REPORTS SAVED YET.</div>`}
      </div>
    `;

    libEl.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const hash = btn.getAttribute("data-del");
        if (!hash) return;

        btn.disabled = true;
        setStatus("DELETING…");

        try{
          const resp = await fetch(API_BASE + "/api/delete", {
            method: "POST",
            headers: headersJson(),
            body: JSON.stringify({ hash })
          });
          const data = await resp.json().catch(()=>({}));
          if (!resp.ok) throw new Error((data.error || "DELETE FAILED") + (data.details ? " — " + data.details : ""));
          addSys("DELETED ✅");
          await refreshLibrary();
        } catch(e){
          addSys("DELETE ERROR: " + (e.message || e), true);
        } finally {
          btn.disabled = false;
        }
      });
    });
  }

  async function refreshLibrary(){
    try{
      const resp = await fetch(API_BASE + "/api/library", {
        method: "GET",
        headers: headersJson()
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok) throw new Error(data.error || "LIBRARY FAILED");
      renderLibrary(data.items || []);
    } catch(e){
      setStatus("LIBRARY ERROR", true);
    }
  }

  async function uploadFiles(){
    const files = Array.from(fileEl.files || []);
    if (!files.length) return addSys("CHOOSE PDFS FIRST", true);

    await ensureSession();

    uploadBtn.disabled = true;
    askBtn.disabled = true;
    setStatus("UPLOADING…");

    const tags = {
      year: (tagYearEl?.value || "").trim(),
      company: (tagCompanyEl?.value || "").trim(),
      topics: (tagTopicsEl?.value || "")
        .split(",")
        .map(s => s.trim())
        .filter(Boolean)
    };

    try{
      const { upload } = await import("https://esm.sh/@vercel/blob@2.0.0/client");

      for (const file of files){
        if (!String(file.name).toLowerCase().endsWith(".pdf")) {
          throw new Error("ONLY PDFS ALLOWED: " + file.name);
        }

        const blob = await upload(file.name, file, {
          access: "public",
          handleUploadUrl: API_BASE + "/api/blob-upload-url",
          headers: DEMO_TOKEN ? { Authorization: "Bearer " + DEMO_TOKEN } : undefined
        });

        const ingestResp = await fetch(API_BASE + "/api/ingest", {
          method: "POST",
          headers: headersJson(),
          body: JSON.stringify({
            blobUrl: blob.url,
            pathname: blob.pathname,
            filename: file.name,
            size: file.size,
            tags
          })
        });

        const ingestData = await ingestResp.json().catch(()=>({}));
        if (!ingestResp.ok){
          throw new Error((ingestData.error || "INGEST FAILED") + (ingestData.details ? " — " + ingestData.details : ""));
        }
        if (ingestData.duplicate){
          addMsg("ai", `DUPLICATE SKIPPED: ${file.name}`);
        } else {
          addMsg("ai", `ADDED: ${file.name} ✅`);
        }
      }

      setStatus("UPLOAD COMPLETE");
      fileEl.value = "";
      await refreshLibrary();
    } catch(e){
      addSys("UPLOAD ERROR: " + (e.message || e), true);
    } finally {
      uploadBtn.disabled = false;
      askBtn.disabled = false;
    }
  }

  async function ask(question){
    const q = (question || "").trim();
    if (!q) return;

    await ensureSession();

    addMsg("me", q);
    setStatus("THINKING…");
    addMsg("ai", "THINKING…");

    askBtn.disabled = true;
    uploadBtn.disabled = true;

    try{
      const resp = await fetch(API_BASE + "/api/ask", {
        method:"POST",
        headers: headersJson(),
        body: JSON.stringify({ question: q, history })
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok) throw new Error((data.error || "REQUEST FAILED") + (data.details ? " — " + data.details : ""));

      addMsg("ai", data.answer || "");
      history = [...history,
        { role:"user", content: q },
        { role:"assistant", content: data.answer || "" }
      ].slice(-16);

      setStatus("DONE");
      addMsg("ai", "DONE.");
    } catch(e){
      addSys("ERROR: " + (e.message || e), true);
    } finally {
      askBtn.disabled = false;
      uploadBtn.disabled = false;
    }
  }

  // Events
  uploadBtn.addEventListener("click", uploadFiles);

  askBtn.addEventListener("click", () => {
    const q = (qEl.value || "").trim();
    if (!q) return;
    qEl.value = "";
    ask(q);
  });

  qEl.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
      e.preventDefault();
      askBtn.click();
    }
  });


  mount.querySelectorAll(".hm-prompt").forEach(btn => {
    btn.addEventListener("click", () => ask(btn.getAttribute("data-prompt")));
  });

  newBtn.addEventListener("click", () => {
    sessionToken = "";
    localStorage.removeItem(LS_KEY);
    history = [];
    chatEl.innerHTML = "";
    addSys("NEW SESSION READY (UPLOAD PDFS)");
  });

  setStatus(sessionToken ? "SESSION READY" : "READY (UPLOAD PDFS)");
  refreshLibrary();


   // =========================
  // FUTURE MAP (SVG layout)
  // =========================

  function polygonPoints(sides, cx, cy, r, rotationDeg){
    const pts = [];
    const rot = (rotationDeg || -90) * Math.PI / 180; // start at top
    for (let i=0; i<sides; i++){
      const a = rot + (i * 2*Math.PI / sides);
      const x = cx + r * Math.cos(a);
      const y = cy + r * Math.sin(a);
      pts.push(`${x.toFixed(2)},${y.toFixed(2)}`);
    }
    return pts.join(" ");
  }

  function drawHeptagons(){
  const g = mount.querySelector("#hmHeptagons");
  if (!g) return;
  g.innerHTML = "";

  // Center of the canvas (your SVG is 1200 x 800)
  const cx = 600;
  const cy = 465; // slightly lower than center to match “title-heavy” top

  // Smaller overall = more text space (tuned)
  const radii = [165, 120, 82, 44]; // 4 layers like your reference

  radii.forEach((r, idx) => {
    const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    poly.setAttribute("points", polygonPoints(7, cx, cy, r, -90));
    poly.setAttribute("fill", "rgba(255,255,255,0.30)");     // 30% white fill
    poly.setAttribute("stroke", "rgba(255,255,255,0.35)");
    poly.setAttribute("stroke-width", idx === 0 ? "2" : "1.5");
    g.appendChild(poly);
  });

  // radial spokes (very subtle)
  const spokes = document.createElementNS("http://www.w3.org/2000/svg", "g");
  spokes.setAttribute("stroke", "rgba(255,255,255,0.14)");
  spokes.setAttribute("stroke-width", "1");

  for (let i=0; i<7; i++){
    const a = (-90 + i*(360/7)) * Math.PI / 180;
    const x2 = cx + radii[0] * Math.cos(a);
    const y2 = cy + radii[0] * Math.sin(a);

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", cx);
    line.setAttribute("y1", cy);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    spokes.appendChild(line);
  }
  g.appendChild(spokes);
}

  // Wrap + clamp so it cannot overflow
  function wrapAndClampLines(str, maxCharsPerLine, maxLines){
    const words = String(str || "").replace(/\s+/g, " ").trim().split(" ").filter(Boolean);
    const lines = [];
    let line = "";

    for (const w of words){
      const next = (line ? line + " " : "") + w;
      if (next.length > maxCharsPerLine){
        if (line) lines.push(line);
        line = w;
        if (lines.length >= maxLines) break;
      } else {
        line = next;
      }
    }
    if (lines.length < maxLines && line) lines.push(line);

    // Clamp with ellipsis if we ran out of room
    if (lines.length === maxLines && words.length){
      const joined = lines.join(" ");
      // heuristic: if original is much longer, add …
      if (joined.length < String(str || "").length - 8){
        lines[maxLines - 1] = (lines[maxLines - 1].slice(0, Math.max(0, maxCharsPerLine - 1)) + "…").trim();
      }
    }

    return lines;
  }

  function setLensText(id, bullets, opts){
    const el = mount.querySelector("#" + id);
    if (!el) return;

    while (el.firstChild) el.removeChild(el.firstChild);

    const items = Array.isArray(bullets) ? bullets : []; 
    const maxBullets = (opts && opts.maxBullets) || 3; 
    const maxChars = (opts && opts.maxChars) || 34; 
    const maxLinesTotal = (opts && opts.maxLinesTotal) || 10;

    let linesUsed = 0;

    for (const b of items.slice(0, maxBullets)){
      if (linesUsed >= maxLinesTotal) break;

      const bullet = "• " + String(b || "").replace(/^•\s*/,"").trim();
      const lines = wrapAndClampLines(bullet, maxChars, Math.max(1, maxLinesTotal - linesUsed));

      for (let i=0; i<lines.length; i++){
        const t = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        t.setAttribute("x", el.getAttribute("x"));
        t.setAttribute("dy", (linesUsed === 0 && i === 0) ? "0" : "20");
        t.textContent = lines[i];
        el.appendChild(t);
        linesUsed++;
        if (linesUsed >= maxLinesTotal) break;
      }

      // small gap between bullets (if room)
      if (linesUsed < maxLinesTotal){
        const gap = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        gap.setAttribute("x", el.getAttribute("x"));
        gap.setAttribute("dy", "10");
        gap.textContent = "";
        el.appendChild(gap);
        linesUsed++;
      }
    }
  }

  function renderFutureMap(data){
  const theme = String(data?.theme || "").trim();
  mapThemeLabel.textContent = theme ? `THEME: ${theme}` : "";

  const lenses = data?.lenses || {};

  // Top-center: shorter + centered
  setLensText("lens_people_attitudes_behaviours", lenses.people_attitudes_behaviours, {
    maxBullets: 3, maxChars: 60, maxLinesTotal: 5
  });

  // Left / right columns: clamp hard so they never run into footer
  setLensText("lens_profit_models", lenses.profit_models, {
    maxBullets: 3, maxChars: 55, maxLinesTotal: 9
  });
  setLensText("lens_politics_regulation", lenses.politics_regulation, {
    maxBullets: 3, maxChars: 55, maxLinesTotal: 9
  });

  setLensText("lens_prosperity_economic_factors", lenses.prosperity_economic_factors, {
    maxBullets: 3, maxChars: 55, maxLinesTotal: 9
  });

  // Bottom areas must be shorter
  setLensText("lens_planet_sustainability", lenses.planet_sustainability, {
    maxBullets: 3, maxChars: 55, maxLinesTotal: 7
  });
  setLensText("lens_places_channels", lenses.places_channels, {
    maxBullets: 3, maxChars: 55, maxLinesTotal: 7
  });

  setLensText("lens_potential_capability", lenses.potential_capability, {
    maxBullets: 3, maxChars: 55, maxLinesTotal: 9
  });

  mapPngBtn.disabled = false;
}


  async function generateFutureMap(){
    
    const theme = (mapThemeEl.value || "").trim();
    if (!theme) return addSys("ENTER A THEME FOR THE FUTURE MAP", true);

    addSys("GENERATING FUTURE MAP…");
    mapGenBtn.disabled = true;
    mapPngBtn.disabled = true;

    try{
      const resp = await fetch(API_BASE + "/api/future-map", {
        method: "POST",
        headers: headersJson(),
        body: JSON.stringify({ theme })
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok) throw new Error((data.error || "FUTURE MAP FAILED") + (data.details ? " — " + data.details : ""));

      renderFutureMap(data);
        mapWrapEl.classList.remove("hm-hidden"); //show map once ready 
      addSys("FUTURE MAP READY ✅");
    } catch(e){
      addSys("FUTURE MAP ERROR: " + (e.message || e), true);
    } finally {
      mapGenBtn.disabled = false;
    }
  }

  async function downloadFutureMapPng(){
    try{
      const serializer = new XMLSerializer();
      const svgText = serializer.serializeToString(mapSvg);

      const svgBlob = new Blob([svgText], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.crossOrigin = "anonymous";

      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = reject;
        img.src = url;
      });

      const canvas = document.createElement("canvas");
      canvas.width = 2400;   
      canvas.height = 1600;  
      const ctx = canvas.getContext("2d");

      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      URL.revokeObjectURL(url);

      const safeTheme = (mapThemeEl.value || "future-map").trim().toLowerCase().replace(/[^a-z0-9]+/g, "-");
      const a = document.createElement("a");
      a.download = `future-map-${safeTheme}.png`;
      a.href = canvas.toDataURL("image/png");
      document.body.appendChild(a);
      a.click();
      a.remove();
    } catch (e) {
      addSys("PNG DOWNLOAD FAILED: " + (e.message || e), true);
    }
  }

  // init heptagons once
  drawHeptagons();

  // wire buttons (ensure these exist already in your IIFE)
  mapGenBtn.addEventListener("click", generateFutureMap);
  mapPngBtn.addEventListener("click", downloadFutureMapPng);



})();


</script>
